---
import Modal from "./ui/Modal.astro";

type Lang = "es" | "en";
type I18nText = { es: string; en: string };

type Project = {
  title: I18nText;
  description: I18nText;
  tech?: string[];
  link?: string;
  image?: string;
  gallery?: string[];
};

const { project, lang = "en" } = Astro.props as { project: Project; lang?: Lang };

const titleText = project.title?.[lang] ?? project.title.en;
const descText = project.description?.[lang] ?? project.description.en;

const modalId = `proj-${project.title.en.replace(/[^a-z0-9]+/gi, "-").toLowerCase()}`;
const hasGallery = (project.gallery?.length ?? 0) > 0;

const labels = {
  openProject: lang === "es" ? "Abrir proyecto" : "Open project",
  viewProject: lang === "es" ? "Ver proyecto" : "View project",
  viewImages: lang === "es" ? "Ver im√°genes" : "View images",
  viewImage: lang === "es" ? "Ver imagen" : "View image",
  projectPreviewAlt: lang === "es" ? "Vista del proyecto" : "Project preview",
  mainViewAlt: lang === "es" ? "Vista principal del proyecto" : "Main project view",
  thumbAlt: lang === "es" ? "Miniatura" : "Thumbnail",
};
---

<article
  class="group overflow-hidden rounded-xl border border-slate-200 bg-white
         transition-all duration-300 ease-out
         hover:-translate-y-1 hover:shadow-xl hover:shadow-black/10
         dark:border-slate-800 dark:bg-slate-950 dark:hover:shadow-black/30"
>
  {project.image && (
    <div class="relative">
      <img
        src={project.image}
        alt={`${labels.projectPreviewAlt} ${titleText}`}
        class="h-44 w-full object-cover
               transition-transform duration-300 ease-out
               group-hover:scale-[1.03]"
        loading="lazy"
      />

      <div
        class="pointer-events-none absolute inset-0
               bg-gradient-to-t from-black/55 via-black/10 to-transparent
               opacity-0 transition-opacity duration-300 ease-out
               group-hover:opacity-100"
      ></div>

      <div class="absolute right-3 top-3 flex gap-2">
        {project.link && (
          <a
            href={project.link}
            target="_blank"
            rel="noreferrer"
            title={labels.openProject}
            aria-label={labels.openProject}
            class="inline-flex h-10 w-10 items-center justify-center rounded-lg
                   bg-white/90 text-slate-900 backdrop-blur
                   opacity-0 translate-y-1
                   transition-all duration-200 ease-out
                   group-hover:opacity-100 group-hover:translate-y-0
                   hover:scale-105 active:scale-95"
          >
            üîó
          </a>
        )}

{hasGallery && (
          <>
            <button
              type="button"
              title={labels.viewImages}
              aria-label={labels.viewImages}
              class="inline-flex h-10 w-10 items-center justify-center rounded-lg
                     bg-white/90 text-slate-900 backdrop-blur
                     opacity-0 translate-y-1
                     transition-all duration-200 ease-out
                     group-hover:opacity-100 group-hover:translate-y-0
                     hover:scale-105 active:scale-95
                     md:opacity-0 md:translate-y-1 md:group-hover:opacity-100 md:group-hover:translate-y-0
                     opacity-100 translate-y-0"
              onclick={`document.getElementById('${modalId}')?.showModal()`}
            >
              üëÅÔ∏è
            </button>

            <Modal id={modalId} title={titleText}>
              <div class="space-y-4">
                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
                  {descText}
                </p>

                <img
                  id={`${modalId}-main`}
                  src={project.gallery?.[0]}
                  alt={`${labels.mainViewAlt} ${titleText}`}
                  class="w-full rounded-lg border border-slate-200 dark:border-slate-800"
                  loading="lazy"
                />

                <div class="flex gap-2 overflow-x-auto pb-1">
                  {project.gallery?.map((img: string, idx: number) => (
                    <button
                      type="button"
                      class={`shrink-0 rounded-lg border transition
                              ${idx === 0 ? "border-slate-900 dark:border-white" : "border-slate-200 dark:border-slate-800"}
                              hover:opacity-90`}
                      onclick={`(() => {
                        const main = document.getElementById('${modalId}-main');
                        if (main) main.setAttribute('src', '${img}');
                      })()`}
                      title={labels.viewImage}
                      aria-label={labels.viewImage}
                    >
                      <img
                        src={img}
                        alt={`${labels.thumbAlt} ${idx + 1} ‚Äî ${titleText}`}
                        class="h-16 w-24 rounded-lg object-cover"
                        loading="lazy"
                      />
                    </button>
                  ))}
                </div>

                {project.link && (
                  <a
                    href={project.link}
                    target="_blank"
                    rel="noreferrer"
                    class="inline-flex items-center gap-2 text-sm font-medium underline underline-offset-4
                           text-slate-900 hover:opacity-80 dark:text-slate-100"
                  >
                    {labels.openProject} <span aria-hidden="true">‚Üí</span>
                  </a>
                )}
              </div>
            </Modal>
          </>
        )}
      </div>
    </div>
  )}

  <div class="p-5">
    <h3 class="font-semibold tracking-tight">{titleText}</h3>

    <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
      {descText}
    </p>

    <div class="mt-3 flex flex-wrap gap-2">
      {project.tech?.map((t: string) => (
        <span
          class="rounded-full bg-slate-100 px-2 py-1 text-xs text-slate-700
                 transition-all duration-200 ease-out
                 hover:-translate-y-0.5 hover:bg-slate-200
                 dark:bg-slate-900 dark:text-slate-200 dark:border dark:border-slate-800
                 dark:hover:bg-slate-800"
        >
          {t}
        </span>
      ))}
    </div>

    {project.link && (
      <a
        href={project.link}
        target="_blank"
        rel="noreferrer"
        class="mt-4 inline-flex items-center gap-2 text-sm font-medium
               underline underline-offset-4
               text-slate-900 transition-opacity duration-200 ease-out
               hover:opacity-80 dark:text-slate-100"
      >
        {labels.viewProject} <span aria-hidden="true">‚Üí</span>
      </a>
    )}
  </div>
</article>